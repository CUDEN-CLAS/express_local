---
  - name: Install additional OS packages
    become: yes
    yum:
        pkg: "{{ item }}"
        state: installed
    with_items:
        - "@development"

  - name: Download xdebug
    get_url:
      url: "https://xdebug.org/files/xdebug-{{ php_xdebug_version }}.tgz"
      dest: "{{ workspace }}"
    become: yes

  - name: Extract xdebug
    shell: "tar xzf ./xdebug-{{ php_xdebug_version }}.tgz -C {{ workspace }}"
    become: yes
    args:
      chdir: "{{ workspace }}"
      creates: "{{ workspace }}/xdebug-{{ php_xdebug_version }}"

  - name: Build Xdebug.
    shell: >
      {{ item }}
      chdir={{ workspace }}/xdebug-{{ php_xdebug_version }}
      creates={{ workspace }}/xdebug-{{ php_xdebug_version }}/modules/xdebug.so
    with_items:
      - phpize
      - ./configure
      - make
    notify: restart apache

  - name: Ensure Xdebug module path exists.
    file:
      path: "{{ php_xdebug_module_path }}"
      state: directory
      owner: root
      group: root
      mode: 0755

  - name: Move Xdebug module into place.
    shell: >
      cp {{ workspace }}/xdebug-{{ php_xdebug_version }}/modules/xdebug.so {{ php_xdebug_module_path }}/xdebug.so
      creates={{ php_xdebug_module_path }}/xdebug.so
    notify: restart apache

  - name: Copy xdebug ini into main extension config folder.
    template:
      src: xdebug.ini.j2
      dest: "/etc/php.d/{{ php_xdebug_config_filename }}"
      owner: root
      group: root
      mode: 0644
    notify:
      - restart apache
